<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weight Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/url-js/2.6.0/url.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="tab-content" id="trackerTabContent">
            <!-- DAILY VIEW -->
            <div class="tab-pane fade show active" id="daily-view" role="tabpanel" aria-labelledby="daily-tab">
                <h1 class="text-center mb-4 animate__animated animate__fadeIn">Daily Calorie Tracker</h1>
                <div class="row mb-4 justify-content-center">
                    <div class="input-group arrowbuttons col-md-6">
                        <button id="prev-date-button" class="btn btn-primary shadow-sm"><i class="fa-solid fa-arrow-left"></i></button>
                        <input type="text" id="date-input" class="form-control text-center shadow-sm" readonly>
                        <button id="next-date-button" class="btn btn-primary shadow-sm"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
                <div class="input-group mb-3 mt-3 col-md-6 mx-auto">
                    <input type="number" id="weight-input" placeholder="Enter weight (lbs)" class="form-control" min="0">
                    <button id="add-weight-btn" class="btn btn-primary">Add</button>
                </div>
                <div class="mt-2 fs-5 text-center">
                    Weight: <span id="current-weight" class="badge bg-info">Not recorded</span>
                </div>
                <div class="chart-container" style="max-width: 300px; height: 300px; margin: 0 auto; padding: 20px;">
                    <canvas id="caloriesChart"></canvas>
                </div>
                <ul id="food-list" class="list-group mt-5 shadow-sm rounded"></ul>
                <div class="mt-4 fw-bold fs-3 text-center text-primary">
                    Total Calories: <span id="total-calories" class="badge bg-primary">0</span>
                </div>
                <div class="mt-2 fw-bold fs-3 text-center text-success">
                    Remaining Calories: <span id="remaining-calories" class="badge bg-success">1700</span>
                </div>
                <div class="mt-5 btn-cal">
                    <div class="accordion" id="foodAccordion"></div>
                </div>
            </div>

            <!-- WEEKLY VIEW -->
            <div class="tab-pane fade" id="weekly-view" role="tabpanel" aria-labelledby="weekly-tab">
                <h1 class="text-center mb-4 animate__animated animate__fadeIn">Weekly Calorie Tracker</h1>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Lowest Daily Calories</h5>
                            <p id="lowest-daily-calories" class="card-text fs-4 fw-bold">--</p>
                            <p id="lowest-daily-calories-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Highest Daily Calories</h5>
                            <p id="highest-daily-calories" class="card-text fs-4 fw-bold">--</p>
                            <p id="highest-daily-calories-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                </div>
                <div class="row mb-4 justify-content-center">
                    <div class="input-group arrowbuttons col-md-6">
                        <button id="prev-week-button" class="btn btn-primary shadow-sm"><i class="fa-solid fa-arrow-left"></i></button>
                        <input type="text" id="week-input" class="form-control text-center shadow-sm" readonly>
                        <button id="next-week-button" class="btn btn-primary shadow-sm"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
                <div class="chart-container" style="max-width: 300px; height: 180px; margin: 0 auto;">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <ul id="weekly-list" class="list-group my-3"></ul>
                <p id="weekly-total" class="fs-5 text-center"></p>
                <p id="weekly-remaining" class="fs-5 text-center"></p>
                <p id="weekly-saved" class="fs-5 text-center visually-hidden"></p>
                <div class="d-grid gap-2 mx-y mt-4 visually-hidden">
                    <button class="btn btn-danger mt-2" type="button" id="reset-week-btn">Reset Week</button>
                </div>
            </div>

            <!-- WEEKLY TOTALS VIEW -->
            <div class="tab-pane fade" id="weekly-totals-view" role="tabpanel" aria-labelledby="weekly-totals-tab">
                <h1 class="text-center mb-4 animate__animated animate__fadeIn">Weekly Totals Trend</h1>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Lowest Weekly Calories</h5>
                            <p id="lowest-weekly-calories" class="card-text fs-4 fw-bold">--</p>
                            <p id="lowest-weekly-calories-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Highest Weekly Calories</h5>
                            <p id="highest-weekly-calories" class="card-text fs-4 fw-bold">--</p>
                            <p id="highest-weekly-calories-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                </div>
                <h2 class="text-center mt-4 mb-3">Last 3 Months</h2>
                <div class="chart-container">
                    <canvas id="weeklyTotalsChart"></canvas>
                </div>
                <ul id="weekly-totals-list" class="list-group my-3"></ul>
            </div>

            <!-- WEIGHT VIEW â€“ ALL TIME -->
            <div class="tab-pane fade" id="weight-view" role="tabpanel" aria-labelledby="weight-tab">
                <h1 class="text-center mb-4 animate__animated animate__fadeIn">Weight Tracker</h1>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Lowest Weight</h5>
                            <p id="lowest-weight-display" class="card-text fs-4 fw-bold">--</p>
                            <p id="lowest-weight-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Highest Weight</h5>
                            <p id="highest-weight-display" class="card-text fs-4 fw-bold">--</p>
                            <p id="highest-weight-date" class="card-text small text-muted"></p>
                        </div>
                    </div>
                </div>
                <h2 class="text-center mt-4 mb-3">Weight Trend (All Time)</h2>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
                <ul id="weight-list" class="list-group my-3"></ul>
            </div>

            <!-- DASHBOARD VIEW -->
            <div class="tab-pane fade" id="dashboard-view" role="tabpanel" aria-labelledby="dashboard-tab">
                <h1 class="text-center mb-4 animate__animated animate__fadeIn">Dashboard</h1>
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Average Daily Calories</h5>
                                <p id="avg-daily-calories" class="card-text fs-4 fw-bold">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Average Weight</h5>
                                <p id="avg-weight" class="card-text fs-4 fw-bold">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Weight Change</h5>
                                <p id="weight-change" class="card-text fs-4 fw-bold">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                <h2 class="text-center mt-4 mb-3">Calorie Distribution</h2>
                <div class="chart-container" style="max-width: 400px; height: 400px; margin: 0 auto; padding: 20px;">
                    <canvas id="foodDistributionChart"></canvas>
                </div>
                <h2 class="text-center mt-4 mb-3">Daily Calorie Trend</h2>
                <div class="chart-container">
                    <canvas id="dailyCalorieTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- EXPORT / IMPORT -->
        <div class="mt-4 text-center">
            <button id="export-button" class="btn btn-success m-2"><i class="fas fa-download me-1"></i> Export Data</button>
            <label for="import-button" class="btn btn-primary m-2"><i class="fas fa-upload me-1"></i> Import Data
                <input type="file" id="import-button" accept=".json" style="display: none;">
            </label>
        </div>

        <!-- BOTTOM NAV -->
        <div class="nav-container fixed-bottom">
            <ul class="nav nav-tabs" id="trackerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-view" type="button" role="tab" aria-controls="daily-view" aria-selected="true"><i class="fas fa-calendar-day"></i></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly-view" type="button" role="tab" aria-controls="weekly-view" aria-selected="false"><i class="fas fa-calendar-week"></i></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weekly-totals-tab" data-bs-toggle="tab" data-bs-target="#weekly-totals-view" type="button" role="tab" aria-controls="weekly-totals-view" aria-selected="false"><i class="fas fa-chart-line"></i></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weight-tab" data-bs-toggle="tab" data-bs-target="#weight-view" type="button" role="tab" aria-controls="weight-view" aria-selected="false"><i class="fas fa-weight-scale"></i></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-view" type="button" role="tab" aria-controls="dashboard-view" aria-selected="false"><i class="fas fa-tachometer-alt"></i></button>
                </li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="accordion.js"></script>

    <script>
        /* ============================================================= */
        /* GLOBALS */
        /* ============================================================= */
        let dailyChart, weeklyChart, weightChart, weeklyTotalsChart, foodDistributionChart, dailyCalorieTrendChart;
        let data = { totalCaloriesUsed: 0, remainingCalories: 1700 };
        let currentDate = new Date();
        let currentWeekStart = getWeekStart(currentDate);
        let foodLog = {}, weightLog = {}, weekData = {};
        let currentView = 'daily';

        const TOTAL_WEEKLY_CALORIES = 11900;
        const DAILY_MAXIMUMS = Array(7).fill(1700);
        const DAYS_PER_WEEK = 7;
        const DAYS_OF_WEEK = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const MS_PER_DAY = 24 * 60 * 60 * 1000;
        const MS_PER_WEEK = MS_PER_DAY * DAYS_PER_WEEK;
        const THREE_MONTHS_MS = 90 * MS_PER_DAY;

        /* ============================================================= */
        /* HELPERS */
        /* ============================================================= */
        function getWeekStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = (day + 6) % 7;
            d.setDate(d.getDate() - diff);
            return d;
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getDateString(date) {
            return date.toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'America/New_York' });
        }

        function isDateInCurrentWeek(date) {
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(weekStart.getTime() + (DAYS_PER_WEEK - 1) * MS_PER_DAY);
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d >= weekStart && d <= weekEnd;
        }

        /* ============================================================= */
        /* STORAGE */
        /* ============================================================= */
        function saveData() {
            const ds = getDateString(currentDate);
            const items = document.getElementById('food-list').children;
            foodLog[ds] = Array.from(items).map(i => ({
                name: i.querySelector('.food-name').textContent,
                calories: parseInt(i.querySelector('.calories').textContent)
            }));
            localStorage.setItem('foodLog', JSON.stringify(foodLog));
            localStorage.setItem('weightLog', JSON.stringify(weightLog));
            localStorage.setItem('weekData', JSON.stringify(weekData));
            localStorage.setItem('currentDate', ds);
            localStorage.setItem('currentWeekStart', currentWeekStart.toISOString());
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({ foodLog, weightLog, weekData }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'weight_tracker_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if (d.foodLog && d.weightLog) {
                        foodLog = d.foodLog;
                        weightLog = d.weightLog;
                        weekData = d.weekData || {};
                        localStorage.setItem('foodLog', JSON.stringify(foodLog));
                        localStorage.setItem('weightLog', JSON.stringify(weightLog));
                        localStorage.setItem('weekData', JSON.stringify(weekData));
                        updateUI();
                        alert('Imported!');
                    } else alert('Invalid file.');
                } catch { alert('Error reading file.'); }
                e.target.value = '';
            };
            reader.readAsText(file);
        }

        function loadData() {
            ['foodLog', 'weightLog', 'weekData'].forEach(k => {
                const s = localStorage.getItem(k);
                window[k] = s ? JSON.parse(s) : {};
            });
            currentDate = new Date(); currentDate.setHours(0,0,0,0);
            currentWeekStart = getWeekStart(currentDate);
            currentView = 'daily';
            updateUI();
            setupDragAndDrop();
        }

        /* ============================================================= */
        /* UI UPDATE */
        /* ============================================================= */
        function updateUI() {
            const map = {
                daily: updateDailyUI,
                weekly: updateWeeklyUI,
                'weekly-totals': updateWeeklyTotalsUI,
                weight: updateWeightUI,
                dashboard: updateDashboardUI
            };
            map[currentView]?.();
        }

        function setupDragAndDrop() {
            new Sortable(document.getElementById('food-list'), {
                animation: 150,
                handle: '.drag-handle',
                onEnd: () => { updateFoodLogOrder(); saveData(); }
            });
        }

        function updateFoodLogOrder() {
            const ds = getDateString(currentDate);
            const items = document.getElementById('food-list').children;
            foodLog[ds] = Array.from(items).map(i => ({
                name: i.querySelector('.food-name').textContent,
                calories: parseInt(i.querySelector('.calories').textContent)
            }));
            updateDailyUI();
            if (isDateInCurrentWeek(currentDate)) updateWeeklyUI();
        }

        /* DAILY */
        function updateDailyUI() {
            updateTotalCalories();
            updateFoodList();
            updateWeightDisplay();
            renderDailyChart();
            displayCurrentDate();
        }

        function updateTotalCalories() {
            const ds = getDateString(currentDate);
            const total = (foodLog[ds] || []).reduce((a,i) => a + i.calories, 0);
            const remain = 1700 - total;
            document.getElementById('total-calories').textContent = total;
            const badge = document.getElementById('remaining-calories');
            badge.textContent = remain;
            badge.className = remain < 0 ? 'badge bg-danger' : 'badge bg-success';
            data = { totalCaloriesUsed: total, remainingCalories: remain };
        }

        function updateFoodList() {
            const ds = getDateString(currentDate);
            const list = document.getElementById('food-list');
            list.innerHTML = '';
            if (!foodLog[ds]) return;

            const agg = {};
            foodLog[ds].forEach(i => agg[i.name] = (agg[i.name] || 0) + i.calories);

            const coffee = [], other = [];
            Object.entries(agg).forEach(([n,c]) => (n.toLowerCase().includes('coffee') ? coffee : other).push({name:n,calories:c}));

            const create = ({name,calories}) => {
                const li = Object.assign(document.createElement('li'), {className:'list-group-item d-flex justify-content-between align-items-center',draggable:true});
                const drag = Object.assign(document.createElement('span'),{className:'drag-handle me-2',innerHTML:'<i class="fas fa-grip-vertical"></i>',style:'cursor:grab'});
                const nameSpan = Object.assign(document.createElement('span'),{className:'food-name form-control flex-grow-1',contentEditable:true,textContent:name});
                const calSpan = Object.assign(document.createElement('span'),{className:'calories mx-2',textContent:calories});
                const del = Object.assign(document.createElement('button'),{className:'btn btn-sm btn-danger',innerHTML:'<i class="bi-trash"></i>'});

                nameSpan.onblur = () => {
                    const newName = nameSpan.textContent.trim();
                    if (newName && newName !== name) {
                        foodLog[ds].forEach(i => { if (i.name === name) i.name = newName; });
                        updateFoodList();
                        if (isDateInCurrentWeek(currentDate)) updateWeeklyUI();
                        saveData();
                    } else if (!newName) nameSpan.textContent = name;
                };

                del.onclick = () => {
                    foodLog[ds] = foodLog[ds].filter(i => i.name !== name);
                    updateUI();
                    if (isDateInCurrentWeek(currentDate)) updateWeeklyUI();
                    saveData();
                };

                li.append(drag, nameSpan, calSpan, del);
                return li;
            };

            coffee.reverse().forEach(i => list.appendChild(create(i)));
            other.forEach(i => list.appendChild(create(i)));
        }

        function updateWeightDisplay() {
            const ds = getDateString(currentDate);
            const badge = document.getElementById('current-weight');
            badge.textContent = weightLog[ds] ? `${weightLog[ds]} lbs` : 'Not recorded';
        }

        function renderDailyChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            let used = data.totalCaloriesUsed, remain = data.remainingCalories;
            if (used > 1700) { used = 1700; remain = 0; }
            const bg = used >= 1700 ? ['rgba(255,99,132,0.5)'] : ['rgba(75,192,192,0.5)', 'rgba(200,200,200,0.5)'];
            const border = used >= 1700 ? ['rgba(255,99,132,1)'] : ['rgba(75,192,192,1)', 'rgba(200,200,200,1)'];

            if (!dailyChart) {
                dailyChart = new Chart(ctx, {type:'pie',data:{labels:['Used','Remaining'],datasets:[{data:[used,remain],backgroundColor:bg,borderColor:border,borderWidth:2,cutout:'50%'}]},options:{responsive:true,maintainAspectRatio:false}});
            } else {
                dailyChart.data.datasets[0].data = [used, remain];
                dailyChart.data.datasets[0].backgroundColor = bg;
                dailyChart.data.datasets[0].borderColor = border;
                dailyChart.update();
            }
        }

        function displayCurrentDate() {
            document.getElementById('date-input').value = new Intl.DateTimeFormat('en-US', {year:'numeric',month:'2-digit',day:'2-digit'}).format(currentDate);
        }

        /* WEEKLY */
        function updateWeeklyUI() {
            updateWeeklyList();
            updateWeeklyTotals();
            updateDailyCaloriesMinMax();
            renderWeeklyChart();
            updateWeekDateRange();
        }

        function getWeekData() {
            const data = Array(7).fill(0);
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart.getTime() + i * MS_PER_DAY);
                const ds = getDateString(day);
                if (foodLog[ds]) data[i] = foodLog[ds].reduce((s,i) => s + i.calories, 0);
            }
            return data;
        }

        function updateWeeklyList() {
            const data = getWeekData();
            const list = document.getElementById('weekly-list');
            list.innerHTML = data.map((c,i) => {
                if (c === 0) return '';
                const saved = 1700 - c;
                const col = saved >= 0 ? '#4B5EAA' : '#C0392B';
                return `<li class="list-group-item d-flex justify-content-between"><span>${DAYS_OF_WEEK[i]}: ${c} cals</span><span style="color:${col}">(${Math.abs(saved)} cals)</span></li>`;
            }).join('');
        }

        function updateWeeklyTotals() {
            const data = getWeekData();
            const total = data.reduce((a,b) => a + b, 0);
            const remain = 11900 - total;
            document.getElementById('weekly-total').textContent = `Total: ${total}`;
            document.getElementById('weekly-remaining').textContent = `Remaining: ${remain}`;
        }

        function renderWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const data = getWeekData();
            const bg = data.map(c => c > 1700 ? 'rgba(255,99,132,0.5)' : 'rgba(75,192,192,0.5)');
            const border = data.map(c => c > 1700 ? 'rgba(255,99,132,1)' : 'rgba(75,192,192,1)');
            const max = Math.max(...data, 1700);
            const yMax = Math.ceil(max / 500) * 500;

            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: DAYS_OF_WEEK, datasets: [{ label: 'Calories', data, backgroundColor: bg, borderColor: border, borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: yMax } } }
            });
        }

        function updateWeekDateRange() {
            const start = new Date(currentWeekStart);
            const end = new Date(start.getTime() + 6 * MS_PER_DAY);
            const fmt = d => `${d.getMonth()+1}/${d.getDate()}`;
            document.getElementById('week-input').value = `${fmt(start)} - ${fmt(end)}`;
        }

        function updateDailyCaloriesMinMax() {
            let min = Infinity, max = 0, minD = '', maxD = '';
            Object.keys(foodLog).forEach(ds => {
                const c = foodLog[ds].reduce((s,i) => s + i.calories, 0);
                if (c < min) { min = c; minD = ds; }
                if (c > max) { max = c; maxD = ds; }
            });
            document.getElementById('lowest-daily-calories').textContent = min !== Infinity ? `${min}` : '--';
            document.getElementById('lowest-daily-calories-date').textContent = min !== Infinity ? minD : '';
            document.getElementById('highest-daily-calories').textContent = max > 0 ? `${max}` : '--';
            document.getElementById('highest-daily-calories-date').textContent = max > 0 ? maxD : '';
        }

        /* WEEKLY TOTALS */
        function updateWeeklyTotalsUI() {
            updateWeeklyTotalsList();
            updateWeeklyCaloriesMinMax();
            renderWeeklyTotalsChart();
        }

        function getWeeklyTotalsData() {
            const today = new Date(); today.setHours(0,0,0,0);
            const ago = new Date(today.getTime() - THREE_MONTHS_MS);
            const totals = {};
            Object.keys(foodLog).forEach(ds => {
                const d = new Date(ds);
                if (d >= ago && d <= today) {
                    const ws = getWeekStart(d);
                    const wsStr = getDateString(ws);
                    const c = foodLog[ds].reduce((s,i) => s + i.calories, 0);
                    totals[wsStr] = (totals[wsStr] || 0) + c;
                }
            });
            const sorted = Object.keys(totals).sort((a,b) => new Date(a) - new Date(b));
            return { labels: sorted.map(s => { const d = new Date(s); return `${d.getMonth()+1}/${d.getDate()}`; }), totals: sorted.map(s => totals[s]), weeks: sorted.map(s => ({weekStart:new Date(s),total:totals[s]})) };
        }

        function updateWeeklyTotalsList() {
            const { weeks } = getWeeklyTotalsData();
            const list = document.getElementById('weekly-totals-list');
            list.innerHTML = '';
            weeks.reverse().forEach(w => {
                const wn = getWeekNumber(w.weekStart);
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>Week ${wn}</span><span>${w.total} cals</span></li>`;
            });
        }

        function renderWeeklyTotalsChart() {
            const ctx = document.getElementById('weeklyTotalsChart').getContext('2d');
            const { labels, totals } = getWeeklyTotalsData();
            const bg = totals.map(t => t > 11900 ? 'rgba(255,99,132,0.5)' : 'rgba(75,192,192,0.5)');
            const border = totals.map(t => t > 11900 ? 'rgba(255,99,132,1)' : 'rgba(75,192,192,1)');
            if (weeklyTotalsChart) weeklyTotalsChart.destroy();
            weeklyTotalsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Weekly Total', data: totals, backgroundColor: bg, borderColor: border, borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 15000 } } }
            });
        }

        function updateWeeklyCaloriesMinMax() {
            let min = Infinity, max = 0, minD = '', maxD = '';
            const { totals, weeks } = getWeeklyTotalsData();
            totals.forEach((t,i) => {
                if (t < min) { min = t; minD = getDateString(weeks[i].weekStart); }
                if (t > max) { max = t; maxD = getDateString(weeks[i].weekStart); }
            });
            document.getElementById('lowest-weekly-calories').textContent = min !== Infinity ? `${min}` : '--';
            document.getElementById('lowest-weekly-calories-date').textContent = min !== Infinity ? minD : '';
            document.getElementById('highest-weekly-calories').textContent = max > 0 ? `${max}` : '--';
            document.getElementById('highest-weekly-calories-date').textContent = max > 0 ? maxD : '';
        }

        /* WEIGHT â€“ ALL TIME */
        function updateWeightUI() {
            updateWeightMinMax();
            updateWeightListAllTime();
            renderWeightChartAllTime();
        }

        function updateWeightMinMax() {
            let low = Infinity, high = 0, lowD = '', highD = '';
            Object.entries(weightLog).forEach(([d,w]) => {
                if (w < low) { low = w; lowD = d; }
                if (w > high) { high = w; highD = d; }
            });
            document.getElementById('lowest-weight-display').textContent = low !== Infinity ? `${low} lbs` : '--';
            document.getElementById('lowest-weight-date').textContent = low !== Infinity ? lowD : '';
            document.getElementById('highest-weight-display').textContent = high > 0 ? `${high} lbs` : '--';
            document.getElementById('highest-weight-date').textContent = high > 0 ? highD : '';
        }

        function updateWeightListAllTime() {
            const list = document.getElementById('weight-list');
            list.innerHTML = '';
            const entries = Object.entries(weightLog).map(([ds,w]) => ({date:new Date(ds),weight:w,ds}));
            entries.sort((a,b) => b.date - a.date);

            const weeks = {};
            entries.forEach(e => {
                const ws = getWeekStart(e.date);
                const wsStr = getDateString(ws);
                if (!weeks[wsStr]) weeks[wsStr] = {num:getWeekNumber(ws),days:[]};
                weeks[wsStr].days.push(e);
            });

            Object.keys(weeks).sort((a,b) => new Date(b)-new Date(a)).forEach(wsStr => {
                const {num,days} = weeks[wsStr];
                const start = new Date(wsStr);
                list.innerHTML += `<li class="list-group-item week-divider">Week ${num} (${start.getMonth()+1}/${start.getDate()}/${start.getFullYear()})</li>`;
                days.sort((a,b) => b.date - a.date).forEach(d => {
                    const dayIdx = (new Date(d.ds).getDay() + 6) % 7;
                    list.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${DAYS_OF_WEEK[dayIdx]}</span><span>${d.weight} lbs</span></li>`;
                });
            });
        }

        function renderWeightChartAllTime() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const points = Object.entries(weightLog).map(([ds,w]) => ({date:new Date(ds),weight:w}));
            points.sort((a,b) => a.date - b.date);
            const labels = points.map(p => getDateString(p.date));
            const weights = points.map(p => p.weight);
            const min = weights.length ? Math.min(...weights) : 100;
            const max = weights.length ? Math.max(...weights) : 200;
            const pad = (max - min) * 0.1 || 10;

            if (weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Weight (lbs)', data: weights, borderColor: 'rgba(75,94,170,1)', backgroundColor: 'rgba(75,94,170,0.2)', fill: true, tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: min-pad, max: max+pad } } }
            });
        }

        /* DASHBOARD */
        function updateDashboardUI() {
            updateDashboardMetrics();
            renderFoodDistributionChart();
            renderDailyCalorieTrendChart();
        }

        function updateDashboardMetrics() {
            let totC = 0, days = 0;
            Object.values(foodLog).forEach(d => { totC += d.reduce((s,i)=>s+i.calories,0); days++; });
            document.getElementById('avg-daily-calories').textContent = days ? Math.round(totC/days) : '--';

            let totW = 0, cntW = 0;
            Object.values(weightLog).forEach(w => { totW += w; cntW++; });
            document.getElementById('avg-weight').textContent = cntW ? (totW/cntW).toFixed(1) : '--';

            const dates = Object.keys(weightLog).sort();
            if (dates.length >= 2) {
                const change = weightLog[dates[dates.length-1]] - weightLog[dates[0]];
                document.getElementById('weight-change').textContent = change >= 0 ? `+${change.toFixed(1)} lbs` : `${change.toFixed(1)} lbs`;
            } else {
                document.getElementById('weight-change').textContent = '--';
            }
        }

        function renderFoodDistributionChart() {
            const ctx = document.getElementById('foodDistributionChart').getContext('2d');
            const cat = {};
            Object.values(foodLog).forEach(day => day.forEach(i => cat[i.name.toLowerCase()] = (cat[i.name.toLowerCase()] || 0) + i.calories));
            const top = Object.entries(cat).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const labels = top.map(([k])=>k), data = top.map(([,v])=>v);

            if (foodDistributionChart) foodDistributionChart.destroy();
            foodDistributionChart = new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff'].map(c=>'rgba('+parseInt(c.slice(1,3),16)+','+parseInt(c.slice(3,5),16)+','+parseInt(c.slice(5,7),16)+',0.5)'), borderColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff'], borderWidth:1 }] },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        function renderDailyCalorieTrendChart() {
            const ctx = document.getElementById('dailyCalorieTrendChart').getContext('2d');
            const sorted = Object.keys(foodLog).sort();
            const cals = sorted.map(ds => foodLog[ds].reduce((s,i)=>s+i.calories,0));
            if (dailyCalorieTrendChart) dailyCalorieTrendChart.destroy();
            dailyCalorieTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: sorted, datasets: [{ label: 'Daily Calories', data: cals, borderColor: 'rgba(75,94,170,1)', backgroundColor: 'rgba(75,94,170,0.2)', fill: true }] },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        /* EVENTS */
        document.getElementById('prev-date-button').onclick = () => { currentDate.setDate(currentDate.getDate()-1); currentWeekStart = getWeekStart(currentDate); updateUI(); saveData(); };
        document.getElementById('next-date-button').onclick = () => { currentDate.setDate(currentDate.getDate()+1); currentWeekStart = getWeekStart(currentDate); updateUI(); saveData(); };
        document.getElementById('prev-week-button').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate()-7); updateUI(); saveData(); };
        document.getElementById('next-week-button').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate()+7); updateUI(); saveData(); };
        document.getElementById('add-weight-btn').onclick = () => {
            const w = parseFloat(document.getElementById('weight-input').value);
            if (isNaN(w) || w <= 0) return alert('Invalid weight.');
            weightLog[getDateString(currentDate)] = w;
            document.getElementById('weight-input').value = '';
            updateUI(); saveData();
        };
        document.getElementById('export-button').onclick = exportData;
        document.getElementById('import-button').onchange = importData;

        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.onclick = () => {
                const id = tab.dataset.bsTarget.slice(1);
                currentView = id.includes('totals') ? 'weekly-totals' : id.split('-')[0];
                updateUI();
            };
        });

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>